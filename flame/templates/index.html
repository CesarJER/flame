<!DOCTYPE html>
<html>
  <head>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript">

      function randomDir() {
        var text = "flame-";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for (var i = 0; i < 10; i++)
          text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
      }

      function upload(file, temp_dir)
      {
        var xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function(event) 
        {          
          console.log('progess', file.name, event.loaded, event.total);
        });

        xhr.addEventListener('readystatechange', function(event) 
        {
          console.log(
            'ready state', 
            file.name, 
            xhr.readyState, 
            xhr.readyState == 4 && xhr.status
          );
        });

        xhr.ontimeout = function (e) {
          console.log('WARNING! timed out. File can be incomplete');
        };

        xhr.open('POST', '/upload', true);
        xhr.timeout = 600000;
        xhr.setRequestHeader('X-Filename', file.name);
        xhr.setRequestHeader('Temp-Dir', temp_dir);

        //console.log('sending', file.name, file);
        xhr.send(file);
      }

      $(document).ready(function() {
          $("#predict").click(function(e) {

            var raw_results = document.getElementById("data-body")
            var tab_results = document.getElementById("newtable")
            var temp_dir = randomDir()
            console.log(temp_dir)

            // clear GUI
            raw_results.innerHTML = 'processing... please wait';
            tab_results.innerHTML = '';

            // upload file to server
            var file = document.getElementById("ifile").files[0]
            upload(file, temp_dir)

            // send job
            $.post("/predict", {"ifile"   : file.name,
                                "model"   : $("#myselect option:selected").text(),
                                "version" : $("input[name='version']").val(),
                                "temp_dir": temp_dir
                               })

            // show results
            .done(function(results) {
              raw_results.innerHTML = results;
              
              //console.log(results)

        
        
              var myjson = JSON.parse(results);

              var tbl_body = '<thead><tr><th>#mol</th><th>prediction</th></tr></thead>';
              $.each(myjson, function() {
                var tbl_row = "";
                //console.log(this)
                $.each(this, function(k , v) {
                  //console.log(k,v)
                  tbl_body += "<tr><td>"+(k+1)+"</td><td>"+v+"</td></tr>"; 
                })          
              })
              tab_results.innerHTML = tbl_body;
            
          });
          e.preventDefault();
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">  
          <div class="col-md-6">
            <h2 >Flame predict interface</h2>
          </div>
          
          <div class="col-md-6">
            <img class="pull-right pull-top" src="/static/images/etransafe-logo.png"></image>
          </div>
      </div>  

        <div class="row">
          <div class ="col-md-8">
            <form class="form-horizontal">

              <div class="form-group">
                  <label class="col-sm-2 control-label" for="ifile">Input </label>
                  <div class="col-sm-6">
                    <input type="file" id="ifile" name="ifile">
                  </div>
              </div>
              
              <div class="form-group">
                <label class="col-sm-2 control-label" for="model">model</label>
                <div class="col-sm-8">
                  <select class="form-control" id="myselect" name="model">
                    {% for m in model_list %}
                    <option name="{{ m }}">{{m}}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label class="col-sm-2 control-label" for="version">version</label>
                <div class="col-sm-8">
                  <input class="form-control" type="number" min=0 value=0 name="version">
                </div>
              </div>
              
            </form>
            
          </div>
          
          <div class="col-md-4 ">
            <button class="btn btn-primary active" role="button" id="predict">Predict</button>
          </div>

      </div>

      <div>

        <h3>Results</h3>
        
        <table class= "table table-bordered table-striped" id="newtable" >
        </table>
        
        <h3>Console</h3>
        
        <pre id="data-body">[not run]</pre>

      </div>
    </div>  
  </body>
</html>